## 6. 데이터 압축
> MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 일반적으로 쿼리의 처리 성능과도 직결되지만 백업 및 복구 시간과도 밀접하게 연결된다. 이러한 문제를 해결하기 위해 많은 DBMS에선 데이터 압축 기능을 제공한다.

---

### 6.1 페이지 압축
- MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장
- MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제
- 즉 InnoDB 버퍼 풀엔 데이터 페이지가 적재되면 압축 해제 상태로만 관리
- 문제점
    - 운영체제 또는 하드웨어에 대한 제약 때문에 일반적으로 많이 사용 X
    - 데이터 페이지를 압축한 결과가 용량이 얼마일지 예측이 불가능하다.
    - 적어도 하나의 테이블은 동일한 크기의 페이지(블록)로 통일돼야 한다.

- 페이지 압축 과정
    1. 운영체제(파일 시스템)의 블록 사이즈가 512byte인 경우로 가정
    2. 16KB 페이지를 압축(압축 결과를 7KB로 가정)
    3. MySQL 서버는 디스크에 압축된 결과 7KB를 기록
    4. 디스크에 데이터를 기록한 후, 9KB에 대해 **펀치 홀** 생성
    5. 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB 공간은 다시 운영체제로 반납

---

### 6.2 테이블 압축
- 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 일반적으로 페이지 압축보다 더 활용도가 높은 편
- 문제점
    - 버퍼 풀 공간 활용률이 낮음
    - 쿼리 처리 성능이 낮음
    - 빈번한 데이터 변경 시 압축률이 떨어짐
- 테이블 압축 과정
    1. 16KB의 데이터 페이지를 압축
    2. 설정한 KEY_BLOCK_SIZE가 8KB라고 가정
    3. 압축한 결과가 8KB 이하이면 디스크에 저장(압축 완료)
    4. 압축한 결과가 8KB 초과하면 원본 페이지를 스플릿해서 2개의 페이지에 8KB씩 저장
    5. 나뉜 페이지에 각각에 대해 1~4번 단계를 반복 실행

- KEY_BLOCK_SIZE 결정
    - KEY_BLOCK_SIZE를 4KB 또는 8KB로 테이블 생성
    - 샘플 데이터를 저장해보고 압축 테스트
    - 압축 결과를 보고 판단
    - KEY_BLOCK_SIZE에 따른 압축 결과인 디스크의 데이터 파일 크기는 별 차이가 없다.
    - 압축이 꼭 필요하다면 KEY_BLOCK_SIZE에 따른 압축 실패율을 비교 후 비교적 실패율이 낮은쪽을 선택
    - zlib을 이용해 압축을 싱행 -> CPU 자원을 많이 소모
    - 데이터가 자주 조회되고 변경된다면 압축을 고려대상에서 제거
    
---