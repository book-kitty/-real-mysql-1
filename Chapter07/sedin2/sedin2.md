## 7. 데이터 암호화

### 7.1 MySQL 서버의 데이터 암호화
- MySQL 서버의 I/O 레이어에서만 데이터의 암/복호화 과정이 실행
- MySQL 서버에서 사용자의 쿼리를 처리하는 과정에서 테이블의 데이터가 암호화돼 있는지 여부를 식별할 필요가 없음
- 이러한 암호화 방식을 TDE(Transparent Data Encryption)이라 함

    #### 2단계 키 관리
    - MySQL 서버의 TDE에서 암호화 키는 키링 플러그인에 의해 관리 됨
    - 키링 플러그인의 종류는 다양 -> 마스터 키를 관리하는 방법만 다름 -> MySQL 서버 내부적으로 작동방식은 모두 동일
    - 키링 플러그인은 2단계(2-Tier) 키 관리 방식을 사용
    - MySQL 서버의 데이터 암호화는 **마스터 키**, **테이블스페이스 키** 두 가지 종류의 키를 가지고 있음
        - 마스터 키
            - 키링 플러그인에 의해 관리되는 키(외부 키 관리 솔루션 또는 디스크의 파일에서 가져옴)
            - 이 부분이 마스터 키를 관리하는 방법만 다르다 한 부분
        - 테이블스페이스 키
            - 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 임의의 테이블스페이스 키를 발급
            - MySQL 서버는 마스터 키를 이용해 테이블스페이스 키를 암호화 -> 암호화 된 테이블스페이스 키를 데이터 파일 헤더에 저장
            - 테이블스페이스 키는 테이블이 삭제되지 않는 이상 절대 변경되지 않음
            - MySQL 서버 외부로 노출되지 않기 때문에 테이블스페이스 키를 주기적으로 변경하지 않아도 보안상 취약하지 않다

    #### 암호화와 성능
    - MySQL 서버의 암호화는 TDE 방식이기 때문에 디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB 버퍼 풀에 적재
    - 따라서 일단 데이터 페이지가 메모리에 적재되면 암호화된 테이블과 암호화 되지않은 테이블은 동일한 성능을 보임
    - 단, 복호화 지연 발생
    - TDE를 적용해도 데이터 파일의 크기는 암호화되지 않은 테이블과 동일한 크기를 가진다
    - 같은 테이블에 대해 암호화와 압축이 동시에 적용되면 압축부터 실행 후 암호화를 적용

    #### 암호화와 복제
    - 소스 서버와 레플리카 서버는 서로 각자의 마스터 키와 테이블스페이스 키를 관리
    - 복제 시 소스 서버의 마스터 키 자체가 레플리카 서버로 복제되지 않음
---

### 7.2 keyring_file 플러그인 설치

---

### 7.3 테이블 암호화
- default_table_encryption 시스템 변수를 ON으로 설정하면 테이블 생성 시 ENCRYPTION 옵션을 별도로 설정하지 않아도 암호화된 테이블로 생성

---

### 7.4 언두 로그 및 리두 로그 암호화
- 테이블의 암호화를 적용해도 디스크로 저장되는 데이터만 암호화되고 MySQL 서버의 메모리에 존재하는 데이터는 복호화된 평문으로 관리(InnoDB 버퍼 풀, Undo)
- 이 평문 데이터가 테이블 데이터 파일 이외의 디스크 파일로 기록되는 경우 여전히 평문으로 저장
- 즉 리두 로그, 언두 로그, 복제를 위한 바이너리 로그에는 평문으로 저장
- 이러한 문제점때문에 MySQL 8.0.16 버전부터 innodb_undo_log_encrypt & innodb_redo_log_encrypt 시스템 변수를 이용해 리두 로그, 언두 로그 암호화 저장 가능

---

### 7.5 바이너리 로그 암호화
- 바이너리 로그도 암호화를 위해 2단계(2-Tier) 키 관리 방식 사용
- **바이너리 로그 암호화 키**
    - 테이블 암호화때의 마스터 키와 동일한 역할
- **바이너리 로그 파일 키**
    - 버이너리 로그와 릴레이 로그 파일 단위로 자동으로 생성되어 해당 로그 파일의 데이터 암호화에만 사용됨

---